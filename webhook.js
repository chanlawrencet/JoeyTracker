// See https://github.com/dialogflow/dialogflow-fulfillment-nodejs
// for Dialogflow fulfillment library docs, samples, and to report issues
'use strict';
 
const functions = require('firebase-functions');
const {WebhookClient} = require('dialogflow-fulfillment');
const {Card, Suggestion} = require('dialogflow-fulfillment');
 
process.env.DEBUG = 'dialogflow:debug'; // enables lib debugging statements
 
exports.dialogflowFirebaseFulfillment = functions.https.onRequest((request, response) => {
  const agent = new WebhookClient({ request, response });
  console.log('Dialogflow Request headers: ' + JSON.stringify(request.headers));
  console.log('Dialogflow Request body: ' + JSON.stringify(request.body));
 
  function welcome(agent) {
    agent.add(`Welcome to my agent!`);
  }
 
  function fallback(agent) {
    agent.add(`I didn't understand`);
    agent.add(`I'm sorry, can you try again?`);
  }

  function locToNum (locationName) {
    switch (locationName) {
      case 'cc_p':
        return 0;
      case 'ds':
        return 1;
      case 'tab':
        return 2;
      case 'cc_t':
        return 3;
      case 'carm':
        return 4;
      case 'olin':
        return 5;
      default:
        return -1;
    }
  }

  function locToFullName (locationName) {
    switch (locationName) {
      case 'cc_p':
        return 'Campus Center Professor\'s Row';
      case 'ds':
        return 'Davis Square';
      case 'tab':
        return 'Tufts Administration Building';
      case 'cc_t':
        return 'Campus Center Talbot Ave';
      case 'carm':
        return 'Carmichael Hall';
      case 'olin':
        return 'Olin Center';
      default:
        return -1;
    }
  }

  function getNextDay (currDay, currTime) {
    if (currDay == 6){
      return 0;
    } else {
      return currDay++;
    }
  }

  function timeToAMPM(time) {
    var hourInt = parseInt(time[0] + time[1], 10);
    agent.add(hourInt);
    if (time > '12:59'){
      return String(hourInt - 12) + ':' + time[3] + time[4] + 'PM';
    } else if (time < '13:00' && time >= '12:00'){
      return String(hourInt) + ':' + time[3] + time[4] + 'PM';
    } else{
      return String(hourInt) + ':' + time[3] + time[4] + 'AM';
    }
  }


  function printNextTimes(locationName, locationNum, day, time){
    var data = [
                [
                  ['0:27','0:49','1:10','1:30','1:49','11:00','11:28','11:56','12:24','12:52','13:20','14:03','14:31','14:59','15:27','15:55','16:23','17:08','17:36','18:04','18:47','19:15','19:43','20:11','20:39','21:22','21:50','22:18','22:46'],
                  ['0:32','0:54','1:15','1:35','1:54','11:07','11:35','12:03','12:31','12:59','13:27','14:10','14:38','15:06','15:34','16:02','16:30','17:15','17:43','18:11','18:54','19:22','19:50','20:18','20:46','21:29','21:57','22:25','22:53'],
                  [],
                  ['0:38','1:00','1:21','1:41','2:00','11:14','11:42','12:10','12:38','13:06','13:34','14:17','14:45','15:13','15:41','16:09','16:37','17:22','17:50','18:18','19:01','19:29','19:57','20:25','20:53','21:36','22:04','22:32','23:00'],
                  ['0:03','0:22','1:04','1:25','1:45','11:19','11:47','12:15','12:43','13:11','13:39','14:22','14:50','15:18','15:46','16:14','16:42','17:27','17:55','18:23','19:06','19:34','20:02','20:30','20:58','21:41','22:09','22:37'],
                  ['0:05','0:44','1:06','1:27','1:47','11:21','11:49','12:17','12:45','13:13','13:41','14:24','14:52','15:20','15:48','16:16','16:44','17:29','17:57','18:25','19:08','19:36','20:04','20:32','21:00','21:43','22:11','22:39']

                ],

                [
                  ['08:00', '08:31',  '09:02',  '09:33',  '10:04', '10:35', '11:21', '11:52', '12:23', '12:54', '13:25', '13:56', '14:57', '15:28', '16:02', '16:33', '17:13', '17:44', '18:28', '18:56', '19:24', '19:52', '20:20', '20:48', '21:44', '22:12', '22:39'],
                  ['08:07', '08:38',  '09:09',  '09:40',  '10:11', '10:42', '11:28', '11:59', '12:30', '13:01', '13:32', '14:03', '15:04', '15:35', '16:09', '16:40', '17:20', '17:51', '18:35', '19:03', '19:31', '19:59', '20:27', '20:55', '21:51', '22:19', '22:45'],
                  ['08:09', '08:40',  '09:11',  '09:42',  '10:13', '10:44', '11:30', '12:01', '12:32', '13:03', '13:34', '14:05', '15:06', '15:37', '16:11', '16:42', '17:22'],
                  ['08:17', '08:48',  '09:19',  '09:50',  '10:21', '10:52', '11:38', '12:09', '12:40', '13:11', '13:42', '14:13', '15:14', '15:45', '16:19', '16:50', '17:30', '17:58', '18:42', '19:10', '19:38', '20:06', '20:34', '21:02', '21:58', '22:26', '22:51'],
                  ['08:22', '08:53',  '09:24',  '09:55',  '10:26', '10:57', '11:43', '12:14', '12:45', '13:16', '13:47', '14:18', '15:19', '15:50', '16:24', '16:55', '17:35', '18:03', '18:47', '19:15', '19:43', '20:11', '20:39', '21:07', '22:03', '22:31'],
                  ['08:24', '08:55',  '09:26',  '09:57',  '10:28', '10:59', '11:45', '12:16', '12:47', '13:18', '13:49', '14:20', '15:21', '15:55', '16:26', '17:06', '17:37', '18:05', '18:49', '19:17', '19:45', '20:13', '20:41', '21:09', '22:05', '22:33']

                ]
                // [

                //   ['08:00', '08:31',  '09:02',  '09:33',  '10:04', '10:35', '11:21', '11:52', '12:23', '12:54', '13:25', '13:56', '14:57', '15:28', '16:02', '16:33', '17:13', '17:44', '18:28', '18:56', '19:24', '19:52', '20:20', '20:48', '21:44', '22:12', '22:39'],
                //   ['08:07', '08:38',  '09:09',  '09:40',  '10:11', '10:42', '11:28', '11:59', '12:30', '13:01', '13:32', '14:03', '15:04', '15:35', '16:09', '16:40', '17:20', '17:51', '18:35', '19:03', '19:31', '19:59', '20:27', '20:55', '21:51', '22:19', '22:45'],
                //   ['08:09', '08:40',  '09:11',  '09:42',  '10:13', '10:44', '11:30', '12:01', '12:32', '13:03', '13:34', '14:05', '15:06', '15:37', '16:11', '16:42', '17:22'],
                //   ['08:17', '08:48',  '09:19',  '09:50',  '10:21', '10:52', '11:38', '12:09', '12:40', '13:11', '13:42', '14:13', '15:14', '15:45', '16:19', '16:50', '17:30', '17:58', '18:42', '19:10', '19:38', '20:06', '20:34', '21:02', '21:58', '22:26', '22:51'],
                //   ['08:22', '08:53',  '09:24',  '09:55',  '10:26', '10:57', '11:43', '12:14', '12:45', '13:16', '13:47', '14:18', '15:19', '15:50', '16:24', '16:55', '17:35', '18:03', '18:47', '19:15', '19:43', '20:11', '20:39', '21:07', '22:03', '22:31'],
                //   ['08:24', '08:55',  '09:26',  '09:57',  '10:28', '10:59', '11:45', '12:16', '12:47', '13:18', '13:49', '14:20', '15:21', '15:55', '16:26', '17:06', '17:37', '18:05', '18:49', '19:17', '19:45', '20:13', '20:41', '21:09', '22:05', '22:33']

                // ],
                // [

                //   ['08:00', '08:31',  '09:02',  '09:33',  '10:04', '10:35', '11:21', '11:52', '12:23', '12:54', '13:25', '13:56', '14:57', '15:28', '16:02', '16:33', '17:13', '17:44', '18:28', '18:56', '19:24', '19:52', '20:20', '20:48', '21:44', '22:12', '22:39'],
                //   ['08:07', '08:38',  '09:09',  '09:40',  '10:11', '10:42', '11:28', '11:59', '12:30', '13:01', '13:32', '14:03', '15:04', '15:35', '16:09', '16:40', '17:20', '17:51', '18:35', '19:03', '19:31', '19:59', '20:27', '20:55', '21:51', '22:19', '22:45'],
                //   ['08:09', '08:40',  '09:11',  '09:42',  '10:13', '10:44', '11:30', '12:01', '12:32', '13:03', '13:34', '14:05', '15:06', '15:37', '16:11', '16:42', '17:22'],
                //   ['08:17', '08:48',  '09:19',  '09:50',  '10:21', '10:52', '11:38', '12:09', '12:40', '13:11', '13:42', '14:13', '15:14', '15:45', '16:19', '16:50', '17:30', '17:58', '18:42', '19:10', '19:38', '20:06', '20:34', '21:02', '21:58', '22:26', '22:51'],
                //   ['08:22', '08:53',  '09:24',  '09:55',  '10:26', '10:57', '11:43', '12:14', '12:45', '13:16', '13:47', '14:18', '15:19', '15:50', '16:24', '16:55', '17:35', '18:03', '18:47', '19:15', '19:43', '20:11', '20:39', '21:07', '22:03', '22:31'],
                //   ['08:24', '08:55',  '09:26',  '09:57',  '10:28', '10:59', '11:45', '12:16', '12:47', '13:18', '13:49', '14:20', '15:21', '15:55', '16:26', '17:06', '17:37', '18:05', '18:49', '19:17', '19:45', '20:13', '20:41', '21:09', '22:05', '22:33']

                // ],
                // [
                //   ['8:00','8:31','9:02','9:33','10:04','10:35','11:21','11:52','12:23','12:54','13:25','13:56','14:57','15:28','16:02','16:33','17:13','17:44','18:05','18:28','18:33','18:56','19:01','19:24','19:29','19:52','19:57','20:20','20:40','20:48','21:08','21:36','21:44','22:04','22:12','22:32','22:39','23:03','23:27','23:30','23:49','23:51'],
                //   ['8:07','8:38','9:09','9:40','10:11','10:42','11:28','11:59','12:30','13:01','13:32','14:03','15:04','15:35','16:09','16:40','17:20','17:51','18:12','18:35','18:40','19:03','19:08','19:31','19:36','19:59','20:04','20:27','20:47','20:55','21:15','21:43','21:51','22:11','22:19','22:39','22:45','23:09','23:33','23:35','23:54','23:56'],
                //   ['8:09','8:40','9:11','9:42','10:13','10:44','11:30','12:01','12:32','13:03','13:34','14:05','15:06','15:37','16:11','16:42','17:22'],
                //   ['8:17','8:48','9:19','9:50','10:21','10:52','11:38','12:09','12:40','13:11','13:42','14:13','15:14','15:45','16:19','16:50','17:30','17:58','18:19','18:42','18:47','19:10','19:15','19:38','19:43','20:06','20:11','20:34','20:54','21:02','21:22','21:50','21:58','22:18','22:26','22:46','22:51','23:15','23:38','23:40'],
                //   ['8:22','8:53','9:24','9:55','10:26','10:57','11:43','12:14','12:45','13:16','13:47','14:18','15:19','15:50','16:24','16:55','17:35','18:03','18:24','18:47','18:52','19:15','19:20','19:43','19:48','20:11','20:16','20:39','20:59','21:07','21:27','21:55','22:03','22:23','22:31','22:51','22:55','23:19','23:42','23:44'],
                //   ['8:24','8:55','9:26','9:57','10:28','10:59','11:45','12:16','12:47','13:18','13:49','14:20','15:21','15:55','16:26','17:06','17:37','18:05','18:26','18:49','18:54','19:17','19:22','19:45','19:50','20:13','20:18','20:41','21:01','21:09','21:29','21:57','22:05','22:25','22:33','22:53','22:57','23:21','23:44','23:46']
                // ],

                // [
                //   ['8:00','8:31','9:02','9:33','10:04','10:35','11:21','11:52','12:23','12:54','13:25','13:56','14:57','15:28','16:02','16:33','17:13','17:44','18:05','18:28','18:33','18:56','19:01','19:24','19:29','19:52','19:57','20:20','20:40','20:48','21:08','21:36','21:44','22:04','22:12','22:32','22:39','23:03','23:27','23:30','23:49','23:51'],
                //   ['8:07','8:38','9:09','9:40','10:11','10:42','11:28','11:59','12:30','13:01','13:32','14:03','15:04','15:35','16:09','16:40','17:20','17:51','18:12','18:35','18:40','19:03','19:08','19:31','19:36','19:59','20:04','20:27','20:47','20:55','21:15','21:43','21:51','22:11','22:19','22:39','22:45','23:09','23:33','23:35','23:54','23:56'],
                //   ['8:09','8:40','9:11','9:42','10:13','10:44','11:30','12:01','12:32','13:03','13:34','14:05','15:06','15:37','16:11','16:42','17:22'],
                //   ['0:00','0:00','8:17','8:48','9:19','9:50','10:21','10:52','11:38','12:09','12:40','13:11','13:42','14:13','15:14','15:45','16:19','16:50','17:30','17:58','18:19','18:42','18:47','19:10','19:15','19:38','19:43','20:06','20:11','20:34','20:54','21:02','21:22','21:50','21:58','22:18','22:26','22:46','22:51','23:15','23:38','23:40'],
                //   ['8:22','8:53','9:24','9:55','10:26','10:57','11:43','12:14','12:45','13:16','13:47','14:18','15:19','15:50','16:24','16:55','17:35','18:03','18:24','18:47','18:52','19:15','19:20','19:43','19:48','20:11','20:16','20:39','20:59','21:07','21:27','21:55','22:03','22:23','22:31','22:51','22:55','23:19','23:42','23:44'],
                //   ['8:24','8:55','9:26','9:57','10:28','10:59','11:45','12:16','12:47','13:18','13:49','14:20','15:21','15:55','16:26','17:06','17:37','18:05','18:26','18:49','18:54','19:17','19:22','19:45','19:50','20:13','20:18','20:41','21:01','21:09','21:29','21:57','22:05','22:25','22:33','22:53','22:57','23:21','23:44','23:46']
                // ],

                // [
                //   ['0:11','0:31','0:51','1:11','1:31','1:51','11:00','11:28','11:56','12:24','12:52','13:20','14:03','14:31','14:59','15:27','15:55','16:12','16:23','16:40','17:06','17:08','17:34','17:36','18:04','18:05','18:33','18:47','19:01','19:15','19:38','19:43','20:05','20:11','20:32','20:39','21:07','21:31','21:50','21:58','22:18','22:25','22:46','22:53','23:19','23:45'],
                //   ['0:16','0:36','0:56','1:16','1:36','1:56','11:07','11:35','12:03','12:31','12:59','13:27','14:10','14:38','15:06','15:34','16:02','16:19','16:30','16:47','17:13','17:15','17:41','17:43','18:11','18:12','18:40','18:54','19:08','19:22','19:45','19:50','20:12','20:18','20:39','20:46','21:14','21:38','21:57','22:05','22:25','22:32','22:53','23:00','23:26','23:52'],
                //   [],
                //   ['0:00','0:00','0:20','0:40','1:00','1:20','1:40','2:00','11:14','11:42','12:10','12:38','13:06','13:34','14:17','14:45','15:13','15:41','16:09','16:26','16:37','16:54','17:20','17:22','17:48','17:50','18:18','18:19','18:47','19:01','19:15','19:29','19:52','19:57','20:19','20:25','20:46','20:53','21:21','21:45','22:04','22:12','22:32','22:39','23:00','23:07','23:33','23:59'],
                //   ['0:04','0:24','0:44','1:04','1:24','1:44','11:19','11:47','12:15','12:43','13:11','13:39','14:22','14:50','15:18','15:46','16:14','16:31','16:42','16:59','17:25','17:27','17:53','17:55','18:23','18:24','18:52','19:06','19:20','19:34','19:57','20:02','20:24','20:30','20:51','20:58','21:26','21:50','22:09','12:17','22:37','22:44','23:11','23:37'],
                //   ['0:06','0:26','0:46','1:06','1:26','1:46','11:21','11:49','12:17','12:45','13:13','13:41','14:24','14:52','15:20','15:48','16:16','16:33','16:44','17:01','17:27','17:29','17:55','17:57','18:25','18:26','18:54','19:08','19:31','19:36','19:59','20:04','20:26','20:32','20:53','21:00','21:28','21:52','22:11','22:19','22:39','22:46','23:13','23:39']
                // ]
              ];

    for (var i = 0; i < data[day][locationNum].length; i++){
        if (data[day][locationNum][i] > time){
          if (i == data[day][locationNum].length - 1) {
            agent.add('Next Joey at ' + locToFullName(locationName) + ' is at ' +  timeToAMPM(data[day][locationNum][i]) + ', with the following at ' +  timeToAMPM(data[getNextDay(day)][locationNum][0]));
          } else {
            agent.add('Next Joey at ' + locToFullName(locationName) + ' is at ' +  timeToAMPM(data[day][locationNum][i]) + ', with the following at ' +  timeToAMPM(data[day][locationNum][i + 1]));
          }
          break;
        }
    }


  }

  function getJS(agent) {
    const locationName = agent.parameters.tufts_locations;

    var today = new Date();
    var day  = today.getDay();
    var time  = today.getTime();
    var locationNum = locToNum(locationName);

    // agent.add(time);

    // "today" is Sunday, 9 am
    day = 0;
    time = '10:00';

    printNextTimes(locationName, locationNum, day, time);     



  }


  // Run the proper function handler based on the matched Dialogflow intent name
  let intentMap = new Map();
  intentMap.set('Default Welcome Intent', welcome);
  intentMap.set('Default Fallback Intent', fallback);
  intentMap.set('get_joey_specified', getJS);
  // intentMap.set('your intent name here', googleAssistantHandler);
  agent.handleRequest(intentMap);
});
